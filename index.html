// Загрузка данных конкретного дня
async function loadDay(dayId) {
  try {
    const response = await fetch(./days/day_${dayId}.json);
    if (!response.ok) throw new Error(Не удалось загрузить день ${dayId});
    return await response.json();
  } catch (error) {
    throw new Error(Ошибка загрузки дня ${dayId}: ${error.message});
  }
}

// Инициализация
async function init() {
  try {
    if (availableDays.length === 0) {
      throw new Error('Нет доступных дней. Добавьте дни в массив availableDays.');
    }
    
    const dayId = availableDays[currentIndex];
    currentDay = await loadDay(dayId);
    
    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    render();
  } catch (error) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('errorMessage').textContent = error.message;
  }
}

function setLang(lang) {
  currentLang = lang;
  render();
}

async function prevDay() {
  if (currentIndex > 0) {
    currentIndex--;
    await loadAndRender();
  }
}

async function nextDay() {
  if (currentIndex < availableDays.length - 1) {
    currentIndex++;
    await loadAndRender();
  }
}

async function setDay(index) {
  currentIndex = index;
  await loadAndRender();
}

async function loadAndRender() {
  try {
    const dayId = availableDays[currentIndex];
    currentDay = await loadDay(dayId);
    render();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch (error) {
    alert('Ошибка загрузки дня: ' + error.message);
  }
}

function render() {
  if (!currentDay) return;

  // Обновление заголовка и дат
  document.getElementById('pageTitle').textContent = currentDay.title[currentLang];
  document.getElementById('gregDate').textContent = currentDay.dateGreg[currentLang];
  document.getElementById('jewDate').textContent = currentDay.dateJewish[currentLang];

  // Обновление кнопок языков
  document.querySelectorAll('[data-lang]').forEach(btn => {
    if (btn.dataset.lang === currentLang) {
      btn.classList.add('btn-active');
    } else {
      btn.classList.remove('btn-active');
    }
  });

  // Обновление кнопок навигации
  document.getElementById('prevBtn').disabled = currentIndex === 0;
  document.getElementById('nextBtn').disabled = currentIndex === availableDays.length - 1;

  // Обновление кнопок дней недели
  const weekButtons = document.getElementById('weekButtons');
  weekButtons.innerHTML = '';
  availableDays.forEach((dayId, idx) => {
    const btn = document.createElement('button');
    btn.textContent = currentDay.weekdayLabel ? currentDay.weekdayLabel[currentLang] : dayId;
    btn.onclick = () => setDay(idx);
    if (idx === currentIndex) btn.classList.add('btn-active');
    weekButtons.appendChild(btn);
  });

  // Обновление контента
  const content = document.getElementById('content');
  content.innerHTML = '';
  
  const sections = currentDay.content[currentLang] || [];
  sections.forEach((section, idx) => {
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'section';
    sectionDiv.style.animationDelay = (idx * 0.05) + 's';
    
    let html = <h2>${section.title}</h2>;
    
    section.text.split('\n\n').forEach(para => {
      html += <p>${para}</p>;
    });
    
    if (section.funFact) {
      html += <div class="fun-fact">${section.funFact}</div>;
    }
    
    if (section.lesson) {
      html += <div class="lesson">${section.lesson}</div>;
    }
    
    sectionDiv.innerHTML = html;
    content.appendChild(sectionDiv);
  });
}

// Обработчик прокрутки
window.addEventListener('scroll', () => {
  const winScroll = document.documentElement.scrollTop;
  const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
  const scrolled = (winScroll / height) * 100;
  document.getElementById('scrollProgress').style.width = scrolled + '%';
});

// Запуск
init();
</script>
</body>
  </html>
